<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-term Calculator</title>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .layout-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .calculator {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
        }

        .results-table {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            display: none;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }

        .final-grade {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            margin: 10px 0;
        }

        .error {
            color: red;
            margin-top: 10px;
        }

        .explanation {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .counter {
            text-align: center;
            padding: 10px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
            border-top: 1px dashed #ddd;
        }

        .counter span {
            display: inline-block;
            background-color: #ffebee;
            padding: 3px 8px;
            border-radius: 12px;
            color: #ff4081;
            font-weight: bold;
            margin: 0 4px;
            animation: bounce 2s infinite;
        }

        .tables-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            white-space: nowrap;
        }

        .score-table {
            border-collapse: collapse;
            font-size: 0.85em;
            flex: 0 0 auto;
            display: inline-block;
            vertical-align: top;
        }

        .score-table th, .score-table td {
            border: 1px solid #ddd;
            padding: 3px 4px;
            text-align: center;
            min-width: 45px;
        }

        .score-table th {
            background-color: #f8f9fa;
            font-size: 0.9em;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .highlighted {
            background-color: #e3f2fd;
            font-weight: bold;
        }

        .results-table {
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 0 0 auto;
            display: none;
            max-height: 500px;
            overflow-x: auto;
        }

        .results-table h2 {
            font-size: 1.1em;
            margin: 0 0 10px 0;
        }
    </style>
</head>
<body>
<div class="layout-container">
    <div class="calculator">
        <h1>N-term Calculator</h1>

        <div class="input-group">
            <label for="maxPoints">Maximaal aantal punten (L):</label>
            <input type="number" id="maxPoints" min="1" step="1" required>
        </div>

        <div class="input-group">
            <label for="nTerm">N-term (tussen -2.0 en 4.0):</label>
            <input type="number" id="nTerm" min="-2.0" max="4.0" step="0.1" required>
        </div>

        <div class="input-group">
            <label for="scoredPoints">Behaalde punten (S):</label>
            <input type="number" id="scoredPoints" min="0" step="1" required>
        </div>

        <button id="calculateButton">Bereken cijfer</button>

        <div id="result" class="result" style="display: none;">
            <h2>Resultaat</h2>
            <div class="final-grade">
                <span id="finalGrade"></span>
            </div>
            <p>Toegepaste formule: <span id="usedFormula"></span></p>
        </div>

        <div id="error" class="error" style="display: none;"></div>
    </div>

    <div id="resultsTable" class="results-table">
        <h2>Puntentabel</h2>
        <div id="tableContainer"></div>
    </div>
</div>

<div class="counter">
    Aantal N-termen berekend: <span id="calculateCounter">0</span> 🎉
</div>

<div class="explanation">
    <h2>Uitleg berekening</h2>
    <p>De berekening gebruikt de volgende formules:</p>
    <p>Hoofdformule: C = 9·S/L + N</p>
    <p>Grensrelaties:</p>
    <ol>
        <li>C < 1 + 2·S·9/L</li>
        <li>C > 1 + 0,5·S·9/L</li>
        <li>C > 10 - 2·(L-S)·9/L</li>
        <li>C < 10 - 0,5·(L-S)·9/L</li>
    </ol>
</div>

<script>
    let calculateCount = parseInt(localStorage.getItem('ntermCalculateCount')) || 0;
    document.getElementById('calculateCounter').textContent = calculateCount;

    const API_BASE = 'https://api.counterapi.dev/v1';
    const NAMESPACE = 'test';
    const COUNTER_NAME = 'test';

    async function getCount() {
        try {
            const response = await fetch(`${API_BASE}/${NAMESPACE}/${COUNTER_NAME}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            calculateCount = data.count;
            document.getElementById('calculateCounter').textContent = calculateCount;
        } catch (error) {
            console.warn('Using local counter:', error);
        }
    }

    async function incrementCounter() {
        try {
            calculateCount++;
            document.getElementById('calculateCounter').textContent = calculateCount;
            localStorage.setItem('ntermCalculateCount', calculateCount);

            const response = await fetch(`${API_BASE}/${NAMESPACE}/${COUNTER_NAME}/up`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            calculateCount = data.count;
            document.getElementById('calculateCounter').textContent = calculateCount;
        } catch (error) {
            console.warn('Using local counter:', error);
        }
    }

    function calculateGradeValue(S, L, N) {
        let C = (9 * S / L) + N;

        const boundary1 = 1 + 2 * S * 9 / L;
        const boundary2 = 1 + 0.5 * S * 9 / L;
        const boundary3 = 10 - 2 * (L - S) * 9 / L;
        const boundary4 = 10 - 0.5 * (L - S) * 9 / L;

        if (C > boundary1) C = boundary1;
        if (C < boundary2) C = boundary2;
        if (C < boundary3) C = boundary3;
        if (C > boundary4) C = boundary4;

        C = Math.max(1, Math.min(10, C));
        return Math.round(C * 10) / 10;
    }

    function updateTable() {
        const L = parseFloat(document.getElementById('maxPoints').value);
        const N = parseFloat(document.getElementById('nTerm').value);
        const currentS = parseFloat(document.getElementById('scoredPoints').value);

        if (!isNaN(L) && !isNaN(N) && L > 0 && N >= -2 && N <= 4) {
            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = '';

            // Create tables container
            const tablesContainer = document.createElement('div');
            tablesContainer.className = 'tables-container';

            // Calculate number of rows per table (aim for about 20 rows per table)
            const rowsPerTable = 20;
            const totalRows = L + 1;
            const numberOfTables = Math.ceil(totalRows / rowsPerTable);

            for (let tableIndex = 0; tableIndex < numberOfTables; tableIndex++) {
                const table = document.createElement('table');
                table.className = 'score-table';

                // Create header
                const header = document.createElement('tr');
                header.innerHTML = '<th>Pnt</th><th>Cijfer</th>';
                table.appendChild(header);

                // Calculate start and end points for this table
                const startPoint = L - (tableIndex * rowsPerTable);
                const endPoint = Math.max(0, startPoint - rowsPerTable + 1);

                // Create rows for this table
                for (let S = startPoint; S >= endPoint; S--) {
                    const row = document.createElement('tr');
                    const grade = calculateGradeValue(S, L, N);

                    // Highlight current score if it matches
                    if (S === currentS) {
                        row.className = 'highlighted';
                    }

                    row.innerHTML = `<td>${S}</td><td>${grade.toFixed(1)}</td>`;
                    table.appendChild(row);
                }

                tablesContainer.appendChild(table);
            }

            tableContainer.appendChild(tablesContainer);
            document.getElementById('resultsTable').style.display = 'block';
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('result').style.display = 'none';
    }

    async function calculateGrade() {
        const L = parseFloat(document.getElementById('maxPoints').value);
        const N = parseFloat(document.getElementById('nTerm').value);
        const S = parseFloat(document.getElementById('scoredPoints').value);

        if (isNaN(L) || isNaN(N) || isNaN(S)) {
            showError("Vul alle velden in.");
            return;
        }

        if (N < -2.0 || N > 4.0) {
            showError("N-term moet tussen -2.0 en 4.0 liggen.");
            return;
        }

        if (S > L) {
            showError("Behaalde punten kunnen niet hoger zijn dan het maximum.");
            return;
        }

        if (S < 0 || L <= 0) {
            showError("Punten moeten positief zijn.");
            return;
        }

        let C = (9 * S / L) + N;
        let usedFormula = "Hoofdformule: C = 9·S/L + N";

        const boundary1 = 1 + 2 * S * 9 / L;
        const boundary2 = 1 + 0.5 * S * 9 / L;
        const boundary3 = 10 - 2 * (L - S) * 9 / L;
        const boundary4 = 10 - 0.5 * (L - S) * 9 / L;

        if (C > boundary1) {
            C = boundary1;
            usedFormula = "Grensrelatie 1: C = 1 + 2·S·9/L";
        }
        if (C < boundary2) {
            C = boundary2;
            usedFormula = "Grensrelatie 2: C = 1 + 0,5·S·9/L";
        }
        if (C < boundary3) {
            C = boundary3;
            usedFormula = "Grensrelatie 3: C = 10 - 2·(L-S)·9/L";
        }
        if (C > boundary4) {
            C = boundary4;
            usedFormula = "Grensrelatie 4: C = 10 - 0,5·(L-S)·9/L";
        }

        C = Math.max(1, Math.min(10, C));
        C = Math.round(C * 10) / 10;

        document.getElementById('result').style.display = 'block';
        document.getElementById('finalGrade').textContent = C.toFixed(1);
        document.getElementById('usedFormula').textContent = usedFormula;
        document.getElementById('error').style.display = 'none';

        updateTable();
        await incrementCounter();
    }

    function handleEnter(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            calculateGrade();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        getCount();

        // Add input event listeners for dynamic table updates
        document.getElementById('maxPoints').addEventListener('input', updateTable);
        document.getElementById('nTerm').addEventListener('input', updateTable);

        // Add event listeners for Enter key
        document.getElementById('maxPoints').addEventListener('keydown', handleEnter);
        document.getElementById('nTerm').addEventListener('keydown', handleEnter);
        document.getElementById('scoredPoints').addEventListener('keydown', handleEnter);

        document.getElementById('calculateButton').addEventListener('click', calculateGrade);
    });
</script>
</body>
</html>