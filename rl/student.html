<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schatzoeken - Doe Mee!</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #1f2937;
            overflow-x: hidden;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        .join-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .join-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .join-card h1 {
            color: var(--primary);
            font-size: 2em;
            margin-bottom: 20px;
        }

        .join-card p {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .code-input {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .code-digit {
            width: 60px;
            height: 70px;
            font-size: 2em;
            text-align: center;
            border: 3px solid var(--primary);
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .code-digit:focus {
            outline: none;
            border-color: var(--accent);
            background: #fef3c7;
        }

        .btn {
            width: 100%;
            padding: 18px;
            font-size: 1.3em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .game-screen {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .game-screen.active {
            display: flex;
        }

        .header {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
        }

        .player-score {
            font-size: 1.2em;
            color: var(--accent);
        }

        .game-status {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .round-info {
            font-size: 1.5em;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .instruction {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .voting-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
        }

        .vote-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .vote-btn {
            aspect-ratio: 1;
            background: white;
            border: 4px solid var(--primary);
            border-radius: 20px;
            font-size: 4em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .vote-btn:active {
            transform: scale(0.95);
        }

        .vote-btn.selected {
            background: var(--accent);
            border-color: var(--accent);
            animation: voteSelected 0.5s;
        }

        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes voteSelected {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .waiting-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .waiting-message {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .waiting-message h2 {
            color: var(--primary);
            font-size: 2em;
            margin-bottom: 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .score-update {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: bold;
            color: var(--secondary);
            animation: scorePopup 1s;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes scorePopup {
            0% { 
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .connection-status.connected {
            background: var(--secondary);
            color: white;
        }

        .connection-status.disconnected {
            background: var(--danger);
            color: white;
        }

        .error-message {
            background: var(--danger);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent);
            animation: confettiFall 3s linear;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .result-display {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .result-display h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .winner { color: var(--secondary); }
        .loser { color: var(--danger); }

        .final-stats {
            font-size: 1.2em;
            color: #6b7280;
            margin-top: 20px;
        }

        @media (max-width: 400px) {
            .code-digit {
                width: 50px;
                height: 60px;
                font-size: 1.5em;
            }
            
            .vote-btn {
                font-size: 3em;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connection-status">
        ‚ö´ Niet verbonden
    </div>

    <div class="container">
        <!-- Join Screen -->
        <div class="join-screen" id="join-screen">
            <div class="join-card">
                <h1>üéÆ Doe mee met het spel!</h1>
                <p>Voer de 4-letter code in van het bord:</p>
                
                <div class="code-input">
                    <input type="text" class="code-digit" maxlength="1" id="digit1" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="digit2" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="digit3" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="digit4" autocomplete="off">
                </div>
                
                <button class="btn btn-primary" id="join-btn" disabled>
                    Doe Mee! üöÄ
                </button>
                
                <div class="error-message" id="error-message"></div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="game-screen">
            <div class="header">
                <div class="player-info">
                    <div class="player-name" id="player-name">Laden...</div>
                    <div class="player-score">Score: <span id="player-score">0</span></div>
                </div>
            </div>

            <div class="game-status">
                <div class="round-info">Ronde <span id="round">1</span> / 10</div>
                <div class="instruction" id="instruction">Wacht op het spel...</div>
            </div>

            <div class="voting-area" id="voting-area">
                <div class="vote-grid">
                    <button class="vote-btn" data-direction="up" disabled>‚¨ÜÔ∏è</button>
                    <button class="vote-btn" data-direction="down" disabled>‚¨áÔ∏è</button>
                    <button class="vote-btn" data-direction="left" disabled>‚¨ÖÔ∏è</button>
                    <button class="vote-btn" data-direction="right" disabled>‚û°Ô∏è</button>
                </div>
            </div>

            <div class="waiting-screen" id="waiting-screen" style="display: none;">
                <div class="waiting-message">
                    <h2 id="waiting-title">Wacht op volgende ronde...</h2>
                    <div class="spinner"></div>
                    <p id="waiting-text">De docent start zo de volgende ronde</p>
                </div>
            </div>

            <div class="result-display" id="result-display" style="display: none;">
                <h2 id="result-title">üéâ Geweldig gedaan!</h2>
                <p id="result-text"></p>
                <div class="final-stats" id="final-stats"></div>
            </div>
        </div>
    </div>

    <div class="celebration" id="celebration"></div>

    <!-- PeerJS for P2P connections -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    
    <script>
        // Student name generation
        const adjectives = ['Blije', 'Slimme', 'Snelle', 'Dappere', 'Vrolijke', 'Sterke', 'Wijze', 'Coole', 'Stoere', 'Wilde'];
        const nouns = ['Banaan', 'Appel', 'Tijger', 'Dolfijn', 'Arend', 'Ster', 'Raket', 'Pizza', 'Draak', 'Ninja'];
        
        function generateStudentName() {
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            return adj + noun;
        }

        class StudentClient {
            constructor() {
                this.peer = null;
                this.connection = null;
                this.playerName = generateStudentName();
                this.score = 0;
                this.hasVoted = false;
                
                this.initElements();
                this.initEventListeners();
            }
            
            initElements() {
                this.joinScreen = document.getElementById('join-screen');
                this.gameScreen = document.getElementById('game-screen');
                this.connectionStatus = document.getElementById('connection-status');
                this.errorMessage = document.getElementById('error-message');
                
                this.digitInputs = [
                    document.getElementById('digit1'),
                    document.getElementById('digit2'),
                    document.getElementById('digit3'),
                    document.getElementById('digit4')
                ];
                
                this.joinBtn = document.getElementById('join-btn');
                this.playerNameEl = document.getElementById('player-name');
                this.playerScoreEl = document.getElementById('player-score');
                this.roundEl = document.getElementById('round');
                this.instructionEl = document.getElementById('instruction');
                
                this.voteButtons = document.querySelectorAll('.vote-btn');
                this.votingArea = document.getElementById('voting-area');
                this.waitingScreen = document.getElementById('waiting-screen');
                this.resultDisplay = document.getElementById('result-display');
            }
            
            initEventListeners() {
                // Code input handling
                this.digitInputs.forEach((input, index) => {
                    input.addEventListener('input', (e) => {
                        const value = e.target.value.toUpperCase();
                        e.target.value = value;
                        
                        if (value && index < 3) {
                            this.digitInputs[index + 1].focus();
                        }
                        
                        this.checkCodeComplete();
                    });
                    
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && !e.target.value && index > 0) {
                            this.digitInputs[index - 1].focus();
                        }
                    });
                });
                
                // Join button
                this.joinBtn.addEventListener('click', () => this.joinGame());
                
                // Vote buttons
                this.voteButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (!this.hasVoted && !btn.disabled) {
                            this.submitVote(btn.dataset.direction);
                        }
                    });
                });
            }
            
            checkCodeComplete() {
                const code = this.digitInputs.map(input => input.value).join('');
                this.joinBtn.disabled = code.length !== 4;
            }
            
            joinGame() {
                const roomCode = this.digitInputs.map(input => input.value).join('').toUpperCase();
                
                this.showLoading();
                
                // Initialize PeerJS
                this.peer = new Peer();
                
                this.peer.on('open', (id) => {
                    console.log('My peer ID:', id);
                    this.connectToHost(roomCode);
                });
                
                this.peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    this.showError('Verbindingsfout. Probeer opnieuw.');
                    this.hideLoading();
                });
            }
            
            connectToHost(roomCode) {
                // Connect to host using room code as peer ID
                const hostPeerId = 'treasurehunt-' + roomCode;
                this.connection = this.peer.connect(hostPeerId);
                
                this.connection.on('open', () => {
                    console.log('Connected to host!');
                    this.onConnected();
                    
                    // Send player info
                    this.connection.send({
                        type: 'join',
                        playerName: this.playerName,
                        playerId: this.peer.id
                    });
                });
                
                this.connection.on('data', (data) => {
                    this.handleHostMessage(data);
                });
                
                this.connection.on('close', () => {
                    this.onDisconnected();
                });
                
                this.connection.on('error', (err) => {
                    console.error('Connection error:', err);
                    this.showError('Kan niet verbinden. Check de code.');
                    this.hideLoading();
                });
            }
            
            handleHostMessage(data) {
                switch(data.type) {
                    case 'welcome':
                        this.playerNameEl.textContent = this.playerName;
                        this.showGameScreen();
                        break;
                        
                    case 'gameStart':
                        this.startGame(data);
                        break;
                        
                    case 'roundStart':
                        this.startRound(data);
                        break;
                        
                    case 'votingStart':
                        this.startVoting(data);
                        break;
                        
                    case 'votingEnd':
                        this.endVoting(data);
                        break;
                        
                    case 'roundEnd':
                        this.endRound(data);
                        break;
                        
                    case 'gameEnd':
                        this.endGame(data);
                        break;
                        
                    case 'scoreUpdate':
                        this.updateScore(data.score);
                        break;
                }
            }
            
            startGame(data) {
                this.score = 0;
                this.playerScoreEl.textContent = '0';
                this.waitingScreen.style.display = 'none';
                this.votingArea.style.display = 'flex';
                this.resultDisplay.style.display = 'none';
            }
            
            startRound(data) {
                this.roundEl.textContent = data.round;
                this.hasVoted = false;
                this.instructionEl.textContent = 'Maak je klaar...';
                this.waitingScreen.style.display = 'none';
                this.votingArea.style.display = 'flex';
                
                // Reset vote buttons
                this.voteButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.remove('selected');
                });
            }
            
            startVoting(data) {
                this.hasVoted = false;
                this.instructionEl.textContent = 'üó≥Ô∏è STEM NU!';
                
                // Enable vote buttons
                this.voteButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('selected');
                });
                
                // Vibrate if supported
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            }
            
            submitVote(direction) {
                if (this.hasVoted) return;
                
                this.hasVoted = true;
                
                // Visual feedback
                this.voteButtons.forEach(btn => {
                    if (btn.dataset.direction === direction) {
                        btn.classList.add('selected');
                    }
                    btn.disabled = true;
                });
                
                // Send vote to host
                this.connection.send({
                    type: 'vote',
                    direction: direction,
                    playerName: this.playerName
                });
                
                this.instructionEl.textContent = '‚úÖ Stem verstuurd!';
            }
            
            endVoting(data) {
                this.voteButtons.forEach(btn => {
                    btn.disabled = true;
                });
                
                if (!this.hasVoted) {
                    this.instructionEl.textContent = '‚è∞ Te laat!';
                }
            }
            
            endRound(data) {
                if (data.winner === 'class' && data.correctVoters && data.correctVoters.includes(this.playerName)) {
                    this.score += 10;
                    this.showScorePopup('+10');
                    this.celebrate();
                }
                
                this.playerScoreEl.textContent = this.score;
                
                // Show waiting screen
                this.waitingScreen.style.display = 'flex';
                this.votingArea.style.display = 'none';
                document.getElementById('waiting-title').textContent = 
                    data.winner === 'class' ? 'üéâ Klas wint!' : 'ü§ñ AI wint!';
            }
            
            endGame(data) {
                this.resultDisplay.style.display = 'block';
                this.waitingScreen.style.display = 'none';
                this.votingArea.style.display = 'none';
                
                const isWinner = data.topPlayers && data.topPlayers[0] === this.playerName;
                
                document.getElementById('result-title').textContent = 
                    isWinner ? 'üèÜ JIJ BENT DE WINNAAR!' : 'üéÆ Goed gespeeld!';
                document.getElementById('result-title').className = isWinner ? 'winner' : '';
                
                document.getElementById('result-text').textContent = 
                    `Je eindscore: ${this.score} punten`;
                
                document.getElementById('final-stats').textContent = 
                    `Klas: ${data.classWins} - AI: ${data.aiWins}`;
                    
                if (isWinner) {
                    this.bigCelebration();
                }
            }
            
            updateScore(score) {
                this.score = score;
                this.playerScoreEl.textContent = score;
            }
            
            showScorePopup(text) {
                const popup = document.createElement('div');
                popup.className = 'score-update';
                popup.textContent = text;
                document.body.appendChild(popup);
                
                setTimeout(() => popup.remove(), 1000);
            }
            
            celebrate() {
                const celebration = document.getElementById('celebration');
                
                for (let i = 0; i < 30; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = ['#2563eb', '#10b981', '#f59e0b', '#ef4444'][Math.floor(Math.random() * 4)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    celebration.appendChild(confetti);
                }
                
                setTimeout(() => {
                    celebration.innerHTML = '';
                }, 3000);
            }
            
            bigCelebration() {
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => this.celebrate(), i * 500);
                }
            }
            
            onConnected() {
                this.connectionStatus.textContent = 'üü¢ Verbonden';
                this.connectionStatus.className = 'connection-status connected';
                this.hideLoading();
            }
            
            onDisconnected() {
                this.connectionStatus.textContent = 'üî¥ Verbinding verbroken';
                this.connectionStatus.className = 'connection-status disconnected';
                this.showError('Verbinding verbroken. Ververs de pagina.');
            }
            
            showGameScreen() {
                this.joinScreen.style.display = 'none';
                this.gameScreen.classList.add('active');
            }
            
            showLoading() {
                this.joinBtn.disabled = true;
                this.joinBtn.textContent = 'Verbinden...';
            }
            
            hideLoading() {
                this.joinBtn.disabled = false;
                this.joinBtn.textContent = 'Doe Mee! üöÄ';
            }
            
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.classList.add('show');
                
                setTimeout(() => {
                    this.errorMessage.classList.remove('show');
                }, 5000);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            new StudentClient();
        });
    </script>
</body>
</html>